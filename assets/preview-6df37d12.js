import{s as E}from"./index-d475d2ea.js";import{M}from"./index-63320c34.js";import"./_commonjsHelpers-042e6b4d.js";var j=(e=>(e.DONE="done",e.ERROR="error",e.ACTIVE="active",e.WAITING="waiting",e))(j||{}),S={CALL:"storybook/instrumenter/call",SYNC:"storybook/instrumenter/sync",START:"storybook/instrumenter/start",BACK:"storybook/instrumenter/back",GOTO:"storybook/instrumenter/goto",NEXT:"storybook/instrumenter/next",END:"storybook/instrumenter/end"},A,D=((A=E.FEATURES)==null?void 0:A.interactionsDebugger)!==!0,m={debugger:!D,start:!1,back:!1,goto:!1,next:!1,end:!1},b=new Error("This function ran after the play function completed. Did you forget to `await` it?"),N=e=>Object.prototype.toString.call(e)==="[object Object]",B=e=>Object.prototype.toString.call(e)==="[object Module]",Y=e=>{if(!N(e)&&!B(e))return!1;if(e.constructor===void 0)return!0;let t=e.constructor.prototype;return!(!N(t)||Object.prototype.hasOwnProperty.call(t,"isPrototypeOf")===!1)},P=e=>{try{return new e.constructor}catch{return{}}},f=()=>({renderPhase:void 0,isDebugging:!1,isPlaying:!1,isLocked:!1,cursor:0,calls:[],shadowCalls:[],callRefsByResult:new Map,chainedCallIds:new Set,ancestors:[],playUntil:void 0,resolvers:{},syncTimeout:void 0}),w=(e,t=!1)=>{let o=(t?e.shadowCalls:e.calls).filter(i=>i.retain);if(!o.length)return;let _=new Map(Array.from(e.callRefsByResult.entries()).filter(([,i])=>i.retain));return{cursor:o.length,calls:o,callRefsByResult:_}},K=class{constructor(){this.initialized=!1,this.channel=__STORYBOOK_MODULE_PREVIEW_API__.addons.getChannel(),this.state=E.window.parent.__STORYBOOK_ADDON_INTERACTIONS_INSTRUMENTER_STATE__||{};let e=({storyId:s,isPlaying:r=!0,isDebugging:n=!1})=>{let a=this.getState(s);this.setState(s,{...f(),...w(a,n),shadowCalls:n?a.shadowCalls:[],chainedCallIds:n?a.chainedCallIds:new Set,playUntil:n?a.playUntil:void 0,isPlaying:r,isDebugging:n}),this.sync(s)};this.channel.on(__STORYBOOK_MODULE_CORE_EVENTS__.FORCE_REMOUNT,e),this.channel.on(__STORYBOOK_MODULE_CORE_EVENTS__.STORY_RENDER_PHASE_CHANGED,({storyId:s,newPhase:r})=>{let{isDebugging:n}=this.getState(s);this.setState(s,{renderPhase:r}),r==="preparing"&&n&&e({storyId:s}),r==="playing"&&e({storyId:s,isDebugging:n}),r==="played"&&this.setState(s,{isLocked:!1,isPlaying:!1,isDebugging:!1}),r==="errored"&&this.setState(s,{isLocked:!1,isPlaying:!1})}),this.channel.on(__STORYBOOK_MODULE_CORE_EVENTS__.SET_CURRENT_STORY,()=>{this.initialized?this.cleanup():this.initialized=!0});let t=({storyId:s,playUntil:r})=>{this.getState(s).isDebugging||this.setState(s,({calls:a})=>({calls:[],shadowCalls:a.map(l=>({...l,status:"waiting"})),isDebugging:!0}));let n=this.getLog(s);this.setState(s,({shadowCalls:a})=>{var d;if(r||!n.length)return{playUntil:r};let l=a.findIndex(h=>h.id===n[0].callId);return{playUntil:(d=a.slice(0,l).filter(h=>h.interceptable&&!h.ancestors.length).slice(-1)[0])==null?void 0:d.id}}),this.channel.emit(__STORYBOOK_MODULE_CORE_EVENTS__.FORCE_REMOUNT,{storyId:s,isDebugging:!0})},o=({storyId:s})=>{var a;let r=this.getLog(s).filter(l=>!l.ancestors.length),n=r.reduceRight((l,d,h)=>l>=0||d.status==="waiting"?l:h,-1);t({storyId:s,playUntil:(a=r[n-1])==null?void 0:a.callId})},_=({storyId:s,callId:r})=>{var u;let{calls:n,shadowCalls:a,resolvers:l}=this.getState(s),d=n.find(({id:O})=>O===r),h=a.find(({id:O})=>O===r);if(!d&&h&&Object.values(l).length>0){let O=(u=this.getLog(s).find(p=>p.status==="waiting"))==null?void 0:u.callId;h.id!==O&&this.setState(s,{playUntil:h.id}),Object.values(l).forEach(p=>p())}else t({storyId:s,playUntil:r})},i=({storyId:s})=>{var n;let{resolvers:r}=this.getState(s);if(Object.values(r).length>0)Object.values(r).forEach(a=>a());else{let a=(n=this.getLog(s).find(l=>l.status==="waiting"))==null?void 0:n.callId;a?t({storyId:s,playUntil:a}):c({storyId:s})}},c=({storyId:s})=>{this.setState(s,{playUntil:void 0,isDebugging:!1}),Object.values(this.getState(s).resolvers).forEach(r=>r())};this.channel.on(S.START,t),this.channel.on(S.BACK,o),this.channel.on(S.GOTO,_),this.channel.on(S.NEXT,i),this.channel.on(S.END,c)}getState(e){return this.state[e]||f()}setState(e,t){let o=this.getState(e),_=typeof t=="function"?t(o):t;this.state={...this.state,[e]:{...o,..._}},E.window.parent.__STORYBOOK_ADDON_INTERACTIONS_INSTRUMENTER_STATE__=this.state}cleanup(){this.state=Object.entries(this.state).reduce((t,[o,_])=>{let i=w(_);return i&&(t[o]=Object.assign(f(),i)),t},{});let e={controlStates:m,logItems:[]};this.channel.emit(S.SYNC,e),E.window.parent.__STORYBOOK_ADDON_INTERACTIONS_INSTRUMENTER_STATE__=this.state}getLog(e){let{calls:t,shadowCalls:o}=this.getState(e),_=[...o];t.forEach((c,s)=>{_[s]=c});let i=new Set;return _.reduceRight((c,s)=>(s.args.forEach(r=>{r!=null&&r.__callId__&&i.add(r.__callId__)}),s.path.forEach(r=>{r.__callId__&&i.add(r.__callId__)}),(s.interceptable||s.exception)&&!i.has(s.id)&&(c.unshift({callId:s.id,status:s.status,ancestors:s.ancestors}),i.add(s.id)),c),[])}instrument(e,t){if(!Y(e))return e;let{mutate:o=!1,path:_=[]}=t;return Object.keys(e).reduce((i,c)=>{let s=e[c];return typeof s!="function"?(i[c]=this.instrument(s,{...t,path:_.concat(c)}),i):typeof s.__originalFn__=="function"?(i[c]=s,i):(i[c]=(...r)=>this.track(c,s,r,t),i[c].__originalFn__=s,Object.defineProperty(i[c],"name",{value:c,writable:!1}),Object.keys(s).length>0&&Object.assign(i[c],this.instrument({...s},{...t,path:_.concat(c)})),i)},o?e:P(e))}track(e,t,o,_){var O,p,g,y;let i=((O=o==null?void 0:o[0])==null?void 0:O.__storyId__)||((y=(g=(p=E.__STORYBOOK_PREVIEW__)==null?void 0:p.selectionStore)==null?void 0:g.selection)==null?void 0:y.storyId),{cursor:c,ancestors:s}=this.getState(i);this.setState(i,{cursor:c+1});let r=`${s.slice(-1)[0]||i} [${c}] ${e}`,{path:n=[],intercept:a=!1,retain:l=!1}=_,d=typeof a=="function"?a(e,n):a,h={id:r,cursor:c,storyId:i,ancestors:s,path:n,method:e,args:o,interceptable:d,retain:l},u=(d&&!s.length?this.intercept:this.invoke).call(this,t,h,_);return this.instrument(u,{..._,mutate:!0,path:[{__callId__:h.id}]})}intercept(e,t,o){let{chainedCallIds:_,isDebugging:i,playUntil:c}=this.getState(t.storyId),s=_.has(t.id);return!i||s||c?(c===t.id&&this.setState(t.storyId,{playUntil:void 0}),this.invoke(e,t,o)):new Promise(r=>{this.setState(t.storyId,({resolvers:n})=>({isLocked:!1,resolvers:{...n,[t.id]:r}}))}).then(()=>(this.setState(t.storyId,r=>{let{[t.id]:n,...a}=r.resolvers;return{isLocked:!0,resolvers:a}}),this.invoke(e,t,o)))}invoke(e,t,o){let{callRefsByResult:_,renderPhase:i}=this.getState(t.storyId),c=n=>{var a,l;if(_.has(n))return _.get(n);if(n instanceof Array)return n.map(c);if(n instanceof Date)return{__date__:{value:n.toISOString()}};if(n instanceof Error){let{name:d,message:h,stack:u}=n;return{__error__:{name:d,message:h,stack:u}}}if(n instanceof RegExp){let{flags:d,source:h}=n;return{__regexp__:{flags:d,source:h}}}if(n instanceof E.window.HTMLElement){let{prefix:d,localName:h,id:u,classList:O,innerText:p}=n,g=Array.from(O);return{__element__:{prefix:d,localName:h,id:u,classNames:g,innerText:p}}}return typeof n=="function"?{__function__:{name:n.name}}:typeof n=="symbol"?{__symbol__:{description:n.description}}:typeof n=="object"&&((a=n==null?void 0:n.constructor)!=null&&a.name)&&((l=n==null?void 0:n.constructor)==null?void 0:l.name)!=="Object"?{__class__:{name:n.constructor.name}}:Object.prototype.toString.call(n)==="[object Object]"?Object.fromEntries(Object.entries(n).map(([d,h])=>[d,c(h)])):n},s={...t,args:t.args.map(c)};t.path.forEach(n=>{n!=null&&n.__callId__&&this.setState(t.storyId,({chainedCallIds:a})=>({chainedCallIds:new Set(Array.from(a).concat(n.__callId__))}))});let r=n=>{if(n instanceof Error){let{name:a,message:l,stack:d,callId:h=t.id}=n,u={name:a,message:l,stack:d,callId:h};if(this.update({...s,status:"error",exception:u}),this.setState(t.storyId,O=>({callRefsByResult:new Map([...Array.from(O.callRefsByResult.entries()),[n,{__callId__:t.id,retain:t.retain}]])})),t.ancestors.length)throw Object.prototype.hasOwnProperty.call(n,"callId")||Object.defineProperty(n,"callId",{value:t.id}),n;if(n!==b)throw __STORYBOOK_MODULE_CLIENT_LOGGER__.logger.warn(n),__STORYBOOK_MODULE_CORE_EVENTS__.IGNORED_EXCEPTION}throw n};try{if(i==="played"&&!t.retain)throw b;let n=(o.getArgs?o.getArgs(t,this.getState(t.storyId)):t.args).map(l=>typeof l!="function"||Object.keys(l).length?l:(...d)=>{let{cursor:h,ancestors:u}=this.getState(t.storyId);this.setState(t.storyId,{cursor:0,ancestors:[...u,t.id]});let O=()=>this.setState(t.storyId,{cursor:h,ancestors:u}),p=!1;try{let g=l(...d);return g instanceof Promise?(p=!0,g.finally(O)):g}finally{p||O()}}),a=e(...n);return a&&["object","function","symbol"].includes(typeof a)&&this.setState(t.storyId,l=>({callRefsByResult:new Map([...Array.from(l.callRefsByResult.entries()),[a,{__callId__:t.id,retain:t.retain}]])})),this.update({...s,status:a instanceof Promise?"active":"done"}),a instanceof Promise?a.then(l=>(this.update({...s,status:"done"}),l),r):a}catch(n){return r(n)}}update(e){this.channel.emit(S.CALL,e),this.setState(e.storyId,({calls:t})=>{let o=t.concat(e).reduce((_,i)=>Object.assign(_,{[i.id]:i}),{});return{calls:Object.values(o).sort((_,i)=>_.id.localeCompare(i.id,void 0,{numeric:!0}))}}),this.sync(e.storyId)}sync(e){let t=()=>{var a;let{isLocked:o,isPlaying:_}=this.getState(e),i=this.getLog(e),c=(a=i.filter(({ancestors:l})=>!l.length).find(l=>l.status==="waiting"))==null?void 0:a.callId,s=i.some(l=>l.status==="active");if(D||o||s||i.length===0){let l={controlStates:m,logItems:i};this.channel.emit(S.SYNC,l);return}let r=i.some(l=>["done","error"].includes(l.status)),n={controlStates:{debugger:!0,start:r,back:r,goto:!0,next:_,end:_},logItems:i,pausedAt:c};this.channel.emit(S.SYNC,n)};this.setState(e,({syncTimeout:o})=>(clearTimeout(o),{syncTimeout:setTimeout(t,0)}))}};function L(e,t={}){var o,_,i,c;try{let s=!1,r=!1;return(_=(o=E.window.location)==null?void 0:o.search)!=null&&_.includes("instrument=true")?s=!0:(c=(i=E.window.location)==null?void 0:i.search)!=null&&c.includes("instrument=false")&&(r=!0),E.window.parent===E.window&&!s||r?e:(E.window.__STORYBOOK_ADDON_INTERACTIONS_INSTRUMENTER__||(E.window.__STORYBOOK_ADDON_INTERACTIONS_INSTRUMENTER__=new K),E.window.__STORYBOOK_ADDON_INTERACTIONS_INSTRUMENTER__.instrument(e,t))}catch(s){return __STORYBOOK_MODULE_CLIENT_LOGGER__.once.warn(s),e}}var I=new M(global),x=I.fn.bind(I),{action:V}=L({action:x},{retain:!0}),U=__STORYBOOK_MODULE_PREVIEW_API__.addons.getChannel(),C=new Set,T=[];U.on(__STORYBOOK_MODULE_CORE_EVENTS__.FORCE_REMOUNT,()=>T.forEach(e=>{var t;return(t=e==null?void 0:e.mockClear)==null?void 0:t.call(e)}));U.on(__STORYBOOK_MODULE_CORE_EVENTS__.STORY_RENDER_PHASE_CHANGED,({newPhase:e})=>{e==="loading"&&T.forEach(t=>{var o;return(o=t==null?void 0:t.mockClear)==null?void 0:o.call(t)})});var R=(e,t,o)=>{if(C.has(t))return t;C.add(t);try{if(Object.prototype.toString.call(t)==="[object Object]"){for(let[_,i]of Object.entries(t))t[_]=R(e,i,_);return t}if(Array.isArray(t))return t.map((_,i)=>R(e,_,`${o}[${i}]`));if(typeof t=="function"&&t.isAction){Object.defineProperty(t,"name",{value:o,writable:!1}),Object.defineProperty(t,"__storyId__",{value:e,writable:!1});let _=V(t);return T.push(_),_}}catch{}return t},G=({id:e,initialArgs:t})=>R(e,t),H=[G],{step:$}=L({step:(e,t,o)=>t(o)},{intercept:!0}),W={throwPlayFunctionExceptions:!1};export{H as argsEnhancers,W as parameters,$ as runStep};
//# sourceMappingURL=preview-6df37d12.js.map
