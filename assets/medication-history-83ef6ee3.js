import{r as d,R as i}from"./index-6f814c40.js";import{n as k,w as F,aL as V,a2 as H,h as U,S as $,aD as B,aE as j,e as X,ak as T,T as z,aM as G,aF as Y,aK as Q,aG as W,aH as K,aI as J,aJ as Z,aN as ee}from"./patient-helper-ccf97625.js";import{k as M,l as L,m as w,n as g,q as te,r as ae,h as m,o as re,v as se,w as A,x as b,b as S,g as I,y as ne,z as ie,A as oe,d as ce}from"./values-6943c5c5.js";import{c as le}from"./index-74f03c09.js";import{D as de}from"./collapsible-data-list-details-f7571cef.js";import{D as ue}from"./document-icon-581c51b2.js";import{w as me}from"./error-boundary-b963f999.js";import{L as pe}from"./loading-c7ff698a.js";import{M as N,i as C,s as fe,j as Ee,k as ye,l as we,m as Me}from"./sort-8ad9bb92.js";import{u as ge}from"./patient-provider-bb8a25bd.js";import"./_baseToString-4993715b.js";import{c as x}from"./sortBy-be5f7eb4.js";import"./_baseClone-25b1595e.js";import{c as R}from"./_basePickBy-239377e6.js";import"./sortBy-919d7262.js";import"./_equalByTag-aaf39779.js";import"./_baseForOwn-d8306f34.js";import"./_createSet-12ef9b81.js";import{u as be}from"./uniqWith-f1edcb30.js";function he(e,a){return d.createElement("svg",Object.assign({xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",strokeWidth:2,stroke:"currentColor","aria-hidden":"true",ref:a},e),d.createElement("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M9 5l7 7-7 7"}))}const _e=d.forwardRef(he),Ne=_e;const h=({date:e,title:a,subtitle:n,data:r,hideEmpty:t,documentButton:s})=>{const[o,c]=d.useState(!1);return i.createElement("div",{className:"ctw-collapsible-data-list ctw-space-y-1","data-zus-telemetry-namespace":"CollapsibleDataList"},i.createElement(De,{date:e,title:a,subtitle:n,isDetailShown:o,setIsDetailShown:c,hasDocument:!!s}),o&&i.createElement(de,{data:r,hideEmpty:t,documentButton:s}))},De=({date:e,title:a,subtitle:n,isDetailShown:r,hasDocument:t=!1,setIsDetailShown:s})=>i.createElement("button",{type:"button","aria-label":"details",onClick:()=>s(!r),"data-zus-telemetry-namespace":"DetailSummary","data-zus-telemetry-click":r?"Collapse":"Expand",className:"ctw-w-full ctw-cursor-pointer ctw-border-none ctw-bg-transparent ctw-p-0 ctw-text-base ctw-outline-none"},i.createElement("div",{className:"ctw-flex ctw-items-center ctw-justify-between ctw-rounded-lg ctw-bg-bg-white ctw-p-3 ctw-text-left ctw-outline ctw-outline-1 ctw-outline-bg-dark"},i.createElement("div",{className:"ctw-flex ctw-space-x-3"},e&&i.createElement("div",{className:"ctw-min-w-[5rem]"},e),i.createElement("div",null,i.createElement("div",{className:"ctw-font-semibold ctw-text-content-black"},a),i.createElement("div",{className:"ctw-text-content-light"},n))),i.createElement("div",{className:"ctw-flex ctw-items-center ctw-space-x-3"},t&&i.createElement(ue,{className:"ctw-fill-content-light hover:ctw-fill-content-light",height:16}),i.createElement("div",{className:"ctw-justify-right ctw-flex"},i.createElement(Ne,{className:le("ctw-h-5 ctw-w-5 ctw-text-primary-dark",{"ctw-rotate-90":r})})))));try{h.displayName="CollapsibleDataList",h.__docgenInfo={description:"",displayName:"CollapsibleDataList",props:{id:{defaultValue:null,description:"",name:"id",required:!0,type:{name:"string"}},date:{defaultValue:null,description:"",name:"date",required:!1,type:{name:"string"}},title:{defaultValue:null,description:"",name:"title",required:!1,type:{name:"string"}},subtitle:{defaultValue:null,description:"",name:"subtitle",required:!1,type:{name:"string"}},data:{defaultValue:null,description:"",name:"data",required:!0,type:{name:"CollapsibleDataListEntry[]"}},hideEmpty:{defaultValue:null,description:"",name:"hideEmpty",required:!1,type:{name:"boolean"}},documentButton:{defaultValue:null,description:"",name:"documentButton",required:!1,type:{name:"ReactNode"}},binaryId:{defaultValue:null,description:"",name:"binaryId",required:!1,type:{name:"string"}}}}}catch{}const _=({entries:e,limit:a})=>{const[n,r]=d.useState(!a||e.length<=a),t=n||!a?e:e.slice(0,a);return i.createElement("div",{className:"ctw-space-y-3","data-zus-telemetry-namespace":"CollapsibleDataListStack"},i.createElement("div",{className:"ctw-text-base ctw-font-medium ctw-uppercase ctw-text-content-light"},"History"),t.map((s,o)=>i.createElement("div",{key:`${s.id}-${o}`},i.createElement(h,{id:s.id,date:s.date,title:s.title,subtitle:s.subtitle,data:s.data,hideEmpty:s.hideEmpty,documentButton:s.documentButton}))),!n&&i.createElement("div",{className:"ctw-text-center"},i.createElement("button",{type:"button",className:"ctw-btn-primary",onClick:()=>r(!0)},"Load ",e.length-a," More")))};try{_.displayName="CollapsibleDataListStack",_.__docgenInfo={description:"",displayName:"CollapsibleDataListStack",props:{entries:{defaultValue:null,description:"",name:"entries",required:!0,type:{name:"CollapsibleDataListStackEntries"}},limit:{defaultValue:null,description:"",name:"limit",required:!1,type:{name:"number"}}}}}catch{}const Se=e=>{const a=m("resource.medicationCodeableConcept.coding.0",e);return a?`${a.system}_${a.code}`:""},Ie=e=>{const a=new Date(e.dateLocal??0);return k(a)},Re=e=>{const a=new Date(e.date??0);return e.resourceType==="MedicationRequest"?a.getTime()-1:a.getTime()},ve=e=>{if(e.length===0)return e;const a=(t,s)=>[t,t.resourceType,s],n=M(L(Ie),w(t=>g(Re,"asc",t)),w(t=>t.map(a)),w(Te))(e);return g(t=>new Date(t).getTime(),"desc",te(n)).map(t=>n[t]).reduce(ae)};function Te(e=[]){const a=new Map,n=e.map(([r,t,s])=>{const o=Se(r);if(t==="MedicationDispense")a.set(o,s);else if(a.has(o)&&t==="MedicationRequest"){const c=a.get(o);return{model:r,type:t,sortOrder:c-.1}}return{model:r,type:t,sortOrder:s}});return g(m("sortOrder"),"desc",n).map(m("model"))}const O=re(["informationSourceNot","informationSource"]);function q(e,a={},n=!1){let r=n?Le(e.resources,e.bundle):e.resources;return a.informationSource&&(r=r.filter(t=>{var s;return((s=t.informationSource)==null?void 0:s.type)===a.informationSource})),a.informationSourceNot&&(r=r.filter(t=>{var s;return((s=t.informationSource)==null?void 0:s.type)!==a.informationSourceNot})),r}async function rt(e,a,n=[]){const[r={}]=n;try{const t=await X("MedicationStatement",e,{patientUPID:a.UPID,_include:"MedicationStatement:medication",...O(r)}),s=q(t,r,!1);return{bundle:t.bundle,medications:s}}catch(t){throw T("Failed fetching medications for patient",t)}}async function st(e,a,n=[]){const[r={}]=n;try{const t=z.timeMetric("req.active_medications"),s=await G("MedicationStatement",e,"ActiveMedications",{patientUPID:a.UPID,_include:"MedicationStatement:medication",...O(r)}),o=q(s,r,!0);return t(),{bundle:s.bundle,medications:o}}catch(t){throw T("Failed fetching medications for patient",t)}}function Le(e,a){const n=ee(a);return e.filter(r=>Ee(r,n)!==void 0)}function nt(e,a){const n=e.filter(t=>!a.some(s=>s.rxNorm===t.rxNorm));return{builderMedications:a.map(t=>{var u,p;const s=I(f=>f.rxNorm===t.rxNorm,e);if(!s)return t;const o=R(t.resource),c=[Y,Q,W,K,J,Z];o.extension=(u=s.resource.extension)==null?void 0:u.filter(f=>c.includes(f.url));const l=R(I({url:B},s.resource.extension));return l&&(l.url=j,(p=o.extension)==null||p.push(l)),new N(o,t.includedResources,t.revIncludes)}),otherProviderMedications:n}}function P(e){const a=e?new N(e).aggregatedFrom:[],n=M(m("reference"),se("/"),A),r=M(L(m("type")),w(b(n)))(a);return ge(V,[(e==null?void 0:e.id)||"empty"],F(async(t,s)=>{try{if(!e)return{includedResources:{},medications:[]};const[o,c,l,u]=await Promise.all([y("MedicationStatement",t,s.UPID,r.MedicationStatement),y("MedicationAdministration",t,s.UPID,r.MedicationAdministration),y("MedicationRequest",t,s.UPID,r.MedicationRequest,["MedicationRequest:requester"]),y("MedicationDispense",t,s.UPID,r.MedicationDispense,["MedicationDispense:performer","MedicationDispense:prescription"])]),p=H(S([o.bundle,c.bundle,l.bundle,u.bundle])),f=S([...o.resources,...c.resources,...l.resources,...u.resources]).map(E=>new C(E,p));return{medications:fe(be(f,(E,D)=>E.date===D.date&&E.resource.resourceType===D.resource.resourceType),"date","desc",!0),includedResources:p}}catch(o){throw new Error(`Failed fetching medication history for medication ${e==null?void 0:e.id}: ${o}`)}},"req.medication_history"))}function it(e){const[a,n]=d.useState(),r=P(e);return d.useEffect(()=>{const{includedResources:t={},medications:s=[]}=r.data||{};if(a===void 0&&s.length){const o=M(b(m("resource")),ne(ie("resourceType","MedicationRequest")),oe(c=>Date.parse(c.authoredOn)),b(c=>new C(c,t)),A,m("prescriber"))(s);n(o||"")}},[a,r.data]),{isLoading:r.isFetching,lastPrescriber:a}}function y(e,a,n,r=[],t=[]){return r.length>0?U(e,a,{_id:r.join(","),_include:[`${e}:patient`,`${e}:medication`,...t],"_include:iterate":"Patient:organization","patient.identifier":`${$}|${n}`}):{resources:[],bundle:void 0}}const Ae=10,v=me(({medication:e})=>{const[a,n]=d.useState([]),r=P(e.resource),t=r.isLoading;return d.useEffect(()=>{if(r.data){const{medications:s}=r.data;n(ve(s).map(xe))}},[r.data]),t?i.createElement(i.Fragment,null,i.createElement("h2",{className:"ctw-text-lg ctw-font-semibold"},"Medication History"),i.createElement(pe,{message:""})):i.createElement(i.Fragment,null,i.createElement("h2",{className:"ctw-text-lg ctw-font-semibold"},"Medication History"),a.length?i.createElement(_,{entries:a,limit:Ae}):i.createElement("span",null,"No history available for this medication."))},"MedicationHistory");function Ce(e){var r,t;const a=e.resource,n=new N(a,e.includedResources);return{date:e.dateLocal,id:e.id,title:"Medication Reviewed",hideEmpty:!1,subtitle:(t=(r=n.patient)==null?void 0:r.organization)==null?void 0:t.name,data:[{label:"Status",value:ce(n.displayStatus)},{label:"Instructions",value:n.dosage}]}}function xe(e){if(e.resourceType==="MedicationStatement")return Ce(e);if(e.resourceType==="MedicationRequest")return Oe(e);if(e.resourceType==="MedicationDispense")return qe(e);if(e.resourceType==="MedicationAdministration")return Pe(e);throw new Error(`Unknown medication resource type "${e.resourceType}"`)}function Oe(e){const a=e.resource,{prescriber:n}=e,{name:r,address:t,telecom:s}=new ye(a,e.includedResources).pharmacy,{numberOfRepeatsAllowed:o="",initialFill:c}=a.dispenseRequest||{},{value:l="",unit:u=""}=(c==null?void 0:c.quantity)||{};return{date:e.dateLocal,id:e.id,title:"Prescription Ordered",subtitle:n,hideEmpty:!1,data:[{label:"Quantity",value:[l,u].join(" ")},{label:"Refills Allowed",value:o},{label:"Instructions",value:e.dosage},{label:"Prescriber",value:n},{label:"Pharmacy",value:i.createElement(i.Fragment,null,r&&i.createElement("div",null,r),t&&i.createElement("div",null,t),s&&i.createElement("div",null,"T: ",s))}]}}function qe(e){const a=e.resource,n=new we(a,e.includedResources),{quantityDisplay:r,supplied:t,performerDetails:s}=n,{name:o,address:c,telecom:l}=s;return{date:e.dateLocal,hideEmpty:!1,id:e.id,title:"Medication Filled",subtitle:x([r,t?`${t} supplied`:null]).join(", "),data:[{label:"Quantity",value:r},{label:"Days supply",value:t},{label:"Pharmacy",value:i.createElement(i.Fragment,null,o&&i.createElement("div",null,o),c&&i.createElement("div",null,c),l&&i.createElement("div",null,"T: ",l))}]}}function Pe(e){const a=e.resource,n=new Me(a,e.includedResources);return{id:e.id,date:e.dateLocal,hideEmpty:!1,title:"Medication Administered",subtitle:x([n.dosageDisplay,n.dosageRoute]).join(", "),data:[{label:"Dosage",value:n.dosageDisplay},{label:"Route",value:n.dosageRoute},{label:"Start Date",value:n.effectivePeriod.start},{label:"End Date",value:n.effectivePeriod.end}]}}try{v.displayName="MedicationHistory",v.__docgenInfo={description:"Displays the history of a medication",displayName:"MedicationHistory",props:{medication:{defaultValue:null,description:"",name:"medication",required:!0,type:{name:"MedicationStatementModel"}}}}}catch{}export{_ as C,v as M,st as a,rt as g,nt as s,it as u};
