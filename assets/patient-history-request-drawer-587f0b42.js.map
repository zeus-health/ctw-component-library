{"version":3,"file":"patient-history-request-drawer-587f0b42.js","sources":["../../src/components/content/forms/schemas/validations.ts","../../src/components/content/forms/schemas/request-history-schema.tsx","../../src/api/patient-history.ts","../../src/components/content/patient-history-request-drawer.tsx"],"sourcesContent":["import { z } from \"zod\";\n\n// Should match all valid formats.\n// See https://stackoverflow.com/a/16699507/1652396\nexport const phoneNumberRegex =\n  /^(\\+\\d{1,2}\\s)?\\(?\\d{3}\\)?[\\s.-]?\\d{3}[\\s.-]?\\d{4}$/;\n\nexport const zipCodeRegex = /^\\d{5}(-\\d{4})?$/;\n\nexport function getStateEnum(requiredError: string) {\n  return z.enum(\n    [\n      \"AL\",\n      \"AK\",\n      \"AZ\",\n      \"AR\",\n      \"CA\",\n      \"CO\",\n      \"CT\",\n      \"DE\",\n      \"DC\",\n      \"FL\",\n      \"GA\",\n      \"HI\",\n      \"ID\",\n      \"IL\",\n      \"IN\",\n      \"IA\",\n      \"KS\",\n      \"KY\",\n      \"LA\",\n      \"ME\",\n      \"MD\",\n      \"MA\",\n      \"MI\",\n      \"MN\",\n      \"MS\",\n      \"MO\",\n      \"MT\",\n      \"NE\",\n      \"NV\",\n      \"NH\",\n      \"NJ\",\n      \"NM\",\n      \"NY\",\n      \"NC\",\n      \"ND\",\n      \"OH\",\n      \"OK\",\n      \"OR\",\n      \"PA\",\n      \"RI\",\n      \"SC\",\n      \"SD\",\n      \"TN\",\n      \"TX\",\n      \"UT\",\n      \"VT\",\n      \"VA\",\n      \"WA\",\n      \"WV\",\n      \"WI\",\n      \"WY\",\n    ],\n    { required_error: requiredError }\n  );\n}\n\nexport function stateCode(state?: string): string {\n  if (!state) return \"\";\n\n  const states: Record<string, string> = {\n    alabama: \"AL\",\n    alaska: \"AK\",\n    arizona: \"AZ\",\n    arkansas: \"AR\",\n    california: \"CA\",\n    colorado: \"CO\",\n    connecticut: \"CT\",\n    delaware: \"DE\",\n    florida: \"FL\",\n    georgia: \"GA\",\n    hawaii: \"HI\",\n    idaho: \"ID\",\n    illinois: \"IL\",\n    indiana: \"IN\",\n    iowa: \"IA\",\n    kansas: \"KS\",\n    kentucky: \"KY\",\n    louisiana: \"LA\",\n    maine: \"ME\",\n    maryland: \"MD\",\n    massachusetts: \"MA\",\n    michigan: \"MI\",\n    minnesota: \"MN\",\n    mississippi: \"MS\",\n    missouri: \"MO\",\n    montana: \"MT\",\n    nebraska: \"NE\",\n    nevada: \"NV\",\n    \"new hampshire\": \"NH\",\n    \"new jersey\": \"NJ\",\n    \"new mexico\": \"NM\",\n    \"new york\": \"NY\",\n    \"north carolina\": \"NC\",\n    \"north dakota\": \"ND\",\n    ohio: \"OH\",\n    oklahoma: \"OK\",\n    oregon: \"OR\",\n    pennsylvania: \"PA\",\n    \"rhode island\": \"RI\",\n    \"south carolina\": \"SC\",\n    \"south dakota\": \"SD\",\n    tennessee: \"TN\",\n    texas: \"TX\",\n    utah: \"UT\",\n    vermont: \"VT\",\n    virginia: \"VA\",\n    washington: \"WA\",\n    \"west virginia\": \"WV\",\n    wisconsin: \"WI\",\n    wyoming: \"WY\",\n  };\n\n  return states[state.toLowerCase()] || state.toUpperCase();\n}\n","import { z } from \"zod\";\nimport {\n  getStateEnum,\n  phoneNumberRegex,\n  stateCode,\n  zipCodeRegex,\n} from \"./validations\";\nimport { FormEntry } from \"@/components/core/form/drawer-form-with-fields\";\nimport { PatientModel } from \"@/fhir/models\";\n\nexport const getRequestData = (patient: PatientModel): FormEntry[] => [\n  {\n    label: \"treating-provider\",\n    render: () => (\n      <div className=\"ctw-font-medium\">\n        Who is the treating provider for this patient?\n      </div>\n    ),\n  },\n  {\n    label: \"Practitioner Name\",\n    field: \"name\",\n    value: \"\",\n    readonly: false,\n  },\n  [\n    {\n      label: \"NPI\",\n      field: \"npi\",\n      value: \"\",\n      readonly: false,\n    },\n    {\n      label: \"Role\",\n      field: \"role\",\n      value: \"\",\n      readonly: false,\n    },\n  ],\n  {\n    label: \"patient-information\",\n    render: () => (\n      <div>\n        <div className=\"ctw-font-medium\">\n          Is the patient information below correct and up-to-date?\n        </div>\n        <div>\n          Complete as many fields as possible to increase matching results.\n        </div>\n      </div>\n    ),\n  },\n  {\n    label: \"First Name\",\n    field: \"firstName\",\n    value: patient.firstName,\n    readonly: false,\n  },\n  {\n    label: \"Last Name\",\n    field: \"lastName\",\n    value: patient.lastName,\n    readonly: false,\n  },\n  [\n    {\n      label: \"Date of Birth\",\n      field: \"dateOfBirth\",\n      value: patient.dob,\n      readonly: false,\n    },\n    {\n      label: \"Gender\",\n      field: \"gender\",\n      value: patient.gender,\n      readonly: false,\n    },\n  ],\n  {\n    label: \"Address\",\n    field: \"address\",\n    value: patient.homeAddress?.line?.join(\", \"),\n    readonly: false,\n  },\n  {\n    label: \"City\",\n    field: \"city\",\n    value: patient.homeAddress?.city,\n    readonly: false,\n  },\n  [\n    {\n      label: \"State\",\n      field: \"state\",\n      value: stateCode(patient.homeAddress?.state),\n      readonly: false,\n    },\n    {\n      label: \"Zip\",\n      field: \"zipCode\",\n      value: patient.homeAddress?.postalCode,\n      readonly: false,\n    },\n  ],\n  {\n    label: \"Phone\",\n    field: \"phone\",\n    value: patient.phoneNumber,\n    readonly: false,\n  },\n  {\n    label: \"Email\",\n    field: \"email\",\n    value: patient.email,\n    readonly: false,\n  },\n];\n\nexport const requestHistorySchema = z.object({\n  name: z.string({\n    required_error: \"Practitioner name must be specified.\",\n  }),\n  npi: z\n    .string({\n      required_error: \"NPI must be specified.\",\n    })\n    .length(10),\n  role: z.enum([\"Doctor\", \"Nurse\", \"Other\"]),\n  firstName: z.string({\n    required_error: \"First name must be specified.\",\n  }),\n  lastName: z.string({\n    required_error: \"Last name must be specified.\",\n  }),\n  dateOfBirth: z\n    .date()\n    .min(new Date(\"1900\"), { message: \"Date of birth is invalid.\" })\n    .max(new Date(), { message: \"Date of birth cannot be a future date.\" }),\n  gender: z.enum([\"-\", \"male\", \"female\", \"other\", \"unknown\"]),\n  address: z.string({\n    required_error: \"Address must be specified.\",\n  }),\n  city: z.string({\n    required_error: \"City must be specified.\",\n  }),\n  state: getStateEnum(\"State must be specified.\"),\n  zipCode: z\n    .string({\n      required_error: \"Zip code must be specified.\",\n    })\n    .regex(zipCodeRegex, {\n      message: \"Zip code is invalid.\",\n    }),\n  phone: z\n    .string()\n    .regex(phoneNumberRegex, { message: \"Phone number is invalid.\" })\n    .optional(),\n  email: z.string().email({ message: \"Email address is invalid.\" }).optional(),\n});\n","import { getZusApiBaseUrl } from \"./urls\";\nimport { CTWRequestContext } from \"@/components/core/providers/ctw-context\";\nimport { ctwFetch } from \"@/utils/request\";\nimport { Telemetry } from \"@/utils/telemetry\";\n\nexport type PatientHistoryResponseError = {\n  // TODO: Can code be a list of status codes? Do we have that type defined anywhere.\n  code: number;\n  title: string;\n  details: string;\n};\n\nexport const schedulePatientHistory = async (\n  requestContext: CTWRequestContext,\n  patientID: string,\n  resultData: { npi: string; role: string; name: string }\n) => {\n  const endpointUrl = `${getZusApiBaseUrl(\n    requestContext.env\n  )}/patient-history/patient/${patientID}/refresh?consent=1`;\n\n  try {\n    const response = await ctwFetch(endpointUrl, {\n      method: \"POST\",\n      headers: {\n        Authorization: `Bearer ${requestContext.authToken}`,\n        \"practitioner-npi\": resultData.npi,\n        \"practitioner-role\": resultData.role.toLocaleLowerCase(),\n        \"practitioner-name\": resultData.name,\n        ...(requestContext.contextBuilderId && {\n          \"Zus-Account\": requestContext.contextBuilderId,\n        }),\n      },\n    });\n    return await response.json();\n  } catch (e) {\n    Telemetry.logError(\n      e as Error,\n      `Error scheduling patient history job with id of ${patientID}`\n    );\n    throw Error(`Error scheduling patient history job with id of ${patientID}`);\n  }\n};\n","import { Dispatch, SetStateAction } from \"react\";\nimport {\n  DrawerFormWithFields,\n  DrawerFormWithFieldsProps,\n} from \"../core/form/drawer-form-with-fields\";\nimport { CTWRequestContext } from \"../core/providers/ctw-context\";\nimport { useHandlePatientSave } from \"../core/providers/patient-provider\";\nimport { PatientFormData } from \"./forms/actions/patients\";\nimport {\n  getRequestData,\n  requestHistorySchema,\n} from \"./forms/schemas/request-history-schema\";\nimport {\n  PatientHistoryResponseError,\n  schedulePatientHistory,\n} from \"@/api/patient-history\";\nimport { PatientModel } from \"@/fhir/models\";\nimport { getFormResponseErrors } from \"@/utils/errors\";\nimport { Telemetry } from \"@/utils/telemetry\";\n\ntype PatientHistoryRequestDrawer<T> = Pick<\n  DrawerFormWithFieldsProps<T>,\n  \"isOpen\" | \"onClose\" | \"header\"\n> & {\n  patient: PatientModel;\n  setClinicalHistoryExists: Dispatch<SetStateAction<boolean | undefined>>;\n};\n\nexport type ScheduleHistoryFormData = {\n  npi: string;\n  role: string;\n  name: string;\n};\n\nexport const PatientHistoryRequestDrawer = <T,>({\n  patient,\n  header,\n  isOpen,\n  onClose,\n  setClinicalHistoryExists,\n}: PatientHistoryRequestDrawer<T>) => {\n  const onPatientSave = useHandlePatientSave(patient);\n\n  const onPatientSaveAndScheduleHistory = async (\n    data: PatientFormData & ScheduleHistoryFormData,\n    getRequestContext: () => Promise<CTWRequestContext>\n  ) => {\n    try {\n      await onPatientSave(data);\n    } catch (e) {\n      const { requestErrors, responseIsSuccess } = getFormResponseErrors(e);\n      if (!responseIsSuccess) {\n        return new Error(requestErrors.join(\",\"));\n      }\n\n      Telemetry.logError(e as Error, \"Failed to save patient data.\");\n      return new Error(\"Failed to save patient data.\");\n    }\n\n    const requestContext = await getRequestContext();\n    const patientHistoryResponse = await schedulePatientHistory(\n      requestContext,\n      patient.id,\n      data\n    );\n\n    if (\"errors\" in patientHistoryResponse) {\n      const requestErrors = [\n        patientHistoryResponse.errors.map(\n          (err: PatientHistoryResponseError) => err.details\n        ),\n      ];\n      return new Error(requestErrors.join(\",\"));\n    }\n\n    // patientHistoryResponse has succeeded at this point and should remove empty request history state.\n    setClinicalHistoryExists(true);\n\n    return patientHistoryResponse;\n  };\n  return (\n    <DrawerFormWithFields\n      header={header}\n      title=\"Request Records\"\n      action={onPatientSaveAndScheduleHistory}\n      data={getRequestData(patient)}\n      schema={requestHistorySchema}\n      isOpen={isOpen}\n      onClose={onClose}\n    />\n  );\n};\n"],"names":["phoneNumberRegex","zipCodeRegex","getStateEnum","requiredError","z","stateCode","state","getRequestData","patient","React","_b","_a","_c","_d","_e","requestHistorySchema","schedulePatientHistory","requestContext","patientID","resultData","endpointUrl","getZusApiBaseUrl","ctwFetch","e","Telemetry","PatientHistoryRequestDrawer","header","isOpen","onClose","setClinicalHistoryExists","onPatientSave","useHandlePatientSave","onPatientSaveAndScheduleHistory","data","getRequestContext","requestErrors","responseIsSuccess","getFormResponseErrors","patientHistoryResponse","err","DrawerFormWithFields"],"mappings":"yKAIO,MAAMA,EACX,sDAEWC,EAAe,mBAErB,SAASC,EAAaC,EAAuB,CAClD,OAAOC,EAAE,KACP,CACE,KACA,KACA,KACA,KACA,KACA,KACA,KACA,KACA,KACA,KACA,KACA,KACA,KACA,KACA,KACA,KACA,KACA,KACA,KACA,KACA,KACA,KACA,KACA,KACA,KACA,KACA,KACA,KACA,KACA,KACA,KACA,KACA,KACA,KACA,KACA,KACA,KACA,KACA,KACA,KACA,KACA,KACA,KACA,KACA,KACA,KACA,KACA,KACA,KACA,KACA,IACF,EACA,CAAE,eAAgBD,CAAc,CAAA,CAEpC,CAEO,SAASE,EAAUC,EAAwB,CAChD,OAAKA,EAEkC,CACrC,QAAS,KACT,OAAQ,KACR,QAAS,KACT,SAAU,KACV,WAAY,KACZ,SAAU,KACV,YAAa,KACb,SAAU,KACV,QAAS,KACT,QAAS,KACT,OAAQ,KACR,MAAO,KACP,SAAU,KACV,QAAS,KACT,KAAM,KACN,OAAQ,KACR,SAAU,KACV,UAAW,KACX,MAAO,KACP,SAAU,KACV,cAAe,KACf,SAAU,KACV,UAAW,KACX,YAAa,KACb,SAAU,KACV,QAAS,KACT,SAAU,KACV,OAAQ,KACR,gBAAiB,KACjB,aAAc,KACd,aAAc,KACd,WAAY,KACZ,iBAAkB,KAClB,eAAgB,KAChB,KAAM,KACN,SAAU,KACV,OAAQ,KACR,aAAc,KACd,eAAgB,KAChB,iBAAkB,KAClB,eAAgB,KAChB,UAAW,KACX,MAAO,KACP,KAAM,KACN,QAAS,KACT,SAAU,KACV,WAAY,KACZ,gBAAiB,KACjB,UAAW,KACX,QAAS,IAAA,EAGGA,EAAM,YAAY,IAAMA,EAAM,cAvDzB,EAwDrB,CCnHO,MAAAC,EAAAC,GAAA,eAAA,OAA+D,CACpE,MAAA,oBACS,OAAA,IAAAC,EAAA,cAAA,MAAA,CAAA,UAAA,iBAAA,EAAA,gDAAA,CAIL,EAEJ,CACA,MAAA,oBACS,MAAA,OACA,MAAA,GACA,SAAA,EACG,EACZ,CACA,CACE,MAAA,MACS,MAAA,MACA,MAAA,GACA,SAAA,EACG,EACZ,CACA,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"}