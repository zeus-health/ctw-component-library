import{r as d,R as i}from"./index-6f814c40.js";import{n as k,a3 as F,w as V,aw as B,u as H,ax as U,ay as $,av as Q,h as Y,S as j,e as z,ac as T,T as X,az as G,aA as W,aB as K,aC as Z,aD as J,aE as ee,aF as te,aG as ae}from"./patient-helper-af20fd5f.js";import{p as g,j as L,m as w,k as M,l as se,n as re,g as m,o as ne,q as ie,r as C,v as b,w as S,b as R,x as oe,y as ce,z as le,d as de}from"./values-0b6ffb91.js";import{c as ue}from"./index-74f03c09.js";import{D as me}from"./collapsible-data-list-details-f7571cef.js";import{D as pe}from"./document-icon-581c51b2.js";import{w as fe}from"./error-boundary-4b057468.js";import{L as Ee}from"./loading-c7ff698a.js";import{r as ye,M as D,a as A,s as we,g as ge,b as Me,c as be,d as he}from"./sort-27a7dcb4.js";import{q as _e}from"./request-5a1df4c1.js";import{u as De}from"./patient-provider-4b62d429.js";import"./_baseToString-4993715b.js";import{c as x}from"./sortBy-be5f7eb4.js";import"./_baseClone-25b1595e.js";import{c as I}from"./_basePickBy-239377e6.js";import"./sortBy-919d7262.js";import"./_equalByTag-aaf39779.js";import"./_baseForOwn-d8306f34.js";import"./_createSet-12ef9b81.js";import{u as Ne}from"./uniqWith-f1edcb30.js";function Se(e,t){return d.createElement("svg",Object.assign({xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",strokeWidth:2,stroke:"currentColor","aria-hidden":"true",ref:t},e),d.createElement("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M9 5l7 7-7 7"}))}const Re=d.forwardRef(Se),Ie=Re;const h=({date:e,title:t,subtitle:n,data:s,hideEmpty:a,documentButton:r})=>{const[o,c]=d.useState(!1);return i.createElement("div",{className:"ctw-collapsible-data-list ctw-space-y-1","data-zus-telemetry-namespace":"CollapsibleDataList"},i.createElement(ve,{date:e,title:t,subtitle:n,isDetailShown:o,setIsDetailShown:c,hasDocument:!!r}),o&&i.createElement(me,{data:s,hideEmpty:a,documentButton:r}))},ve=({date:e,title:t,subtitle:n,isDetailShown:s,hasDocument:a=!1,setIsDetailShown:r})=>i.createElement("button",{type:"button","aria-label":"details",onClick:()=>r(!s),"data-zus-telemetry-namespace":"DetailSummary","data-zus-telemetry-click":s?"Collapse":"Expand",className:"ctw-w-full ctw-cursor-pointer ctw-border-none ctw-bg-transparent ctw-p-0 ctw-text-base ctw-outline-none"},i.createElement("div",{className:"ctw-flex ctw-items-center ctw-justify-between ctw-rounded-lg ctw-bg-bg-white ctw-p-3 ctw-text-left ctw-outline ctw-outline-1 ctw-outline-bg-dark"},i.createElement("div",{className:"ctw-flex ctw-space-x-3"},e&&i.createElement("div",{className:"ctw-min-w-[5rem]"},e),i.createElement("div",null,i.createElement("div",{className:"ctw-font-semibold ctw-text-content-black"},t),i.createElement("div",{className:"ctw-text-content-light"},n))),i.createElement("div",{className:"ctw-flex ctw-items-center ctw-space-x-3"},a&&i.createElement(pe,{className:"ctw-fill-content-light hover:ctw-fill-content-light",height:16}),i.createElement("div",{className:"ctw-justify-right ctw-flex"},i.createElement(Ie,{className:ue("ctw-h-5 ctw-w-5 ctw-text-primary-dark",{"ctw-rotate-90":s})})))));try{h.displayName="CollapsibleDataList",h.__docgenInfo={description:"",displayName:"CollapsibleDataList",props:{id:{defaultValue:null,description:"",name:"id",required:!0,type:{name:"string"}},date:{defaultValue:null,description:"",name:"date",required:!1,type:{name:"string"}},title:{defaultValue:null,description:"",name:"title",required:!1,type:{name:"string"}},subtitle:{defaultValue:null,description:"",name:"subtitle",required:!1,type:{name:"string"}},data:{defaultValue:null,description:"",name:"data",required:!0,type:{name:"CollapsibleDataListEntry[]"}},hideEmpty:{defaultValue:null,description:"",name:"hideEmpty",required:!1,type:{name:"boolean"}},documentButton:{defaultValue:null,description:"",name:"documentButton",required:!1,type:{name:"ReactNode"}},binaryId:{defaultValue:null,description:"",name:"binaryId",required:!1,type:{name:"string"}}}}}catch{}const _=({entries:e,limit:t})=>{const[n,s]=d.useState(!t||e.length<=t),a=n||!t?e:e.slice(0,t);return i.createElement("div",{className:"ctw-space-y-3","data-zus-telemetry-namespace":"CollapsibleDataListStack"},i.createElement("div",{className:"ctw-text-base ctw-font-medium ctw-uppercase ctw-text-content-light"},"History"),a.map((r,o)=>i.createElement("div",{key:`${r.id}-${o}`},i.createElement(h,{id:r.id,date:r.date,title:r.title,subtitle:r.subtitle,data:r.data,hideEmpty:r.hideEmpty,documentButton:r.documentButton}))),!n&&i.createElement("div",{className:"ctw-text-center"},i.createElement("button",{type:"button",className:"ctw-btn-primary",onClick:()=>s(!0)},"Load ",e.length-t," More")))};try{_.displayName="CollapsibleDataListStack",_.__docgenInfo={description:"",displayName:"CollapsibleDataListStack",props:{entries:{defaultValue:null,description:"",name:"entries",required:!0,type:{name:"CollapsibleDataListStackEntries"}},limit:{defaultValue:null,description:"",name:"limit",required:!1,type:{name:"number"}}}}}catch{}const Te=e=>{const t=m("resource.medicationCodeableConcept.coding.0",e);return t?`${t.system}_${t.code}`:""},Le=e=>{const t=new Date(e.dateLocal??0);return k(t)},Ce=e=>{const t=new Date(e.date??0);return e.resourceType==="MedicationRequest"?t.getTime()-1:t.getTime()},Ae=e=>{if(e.length===0)return e;const t=(a,r)=>[a,a.resourceType,r],n=g(L(Le),w(a=>M(Ce,"asc",a)),w(a=>a.map(t)),w(xe))(e);return M(a=>new Date(a).getTime(),"desc",se(n)).map(a=>n[a]).reduce(re)};function xe(e=[]){const t=new Map,n=e.map(([s,a,r])=>{const o=Te(s);if(a==="MedicationDispense")t.set(o,r);else if(t.has(o)&&a==="MedicationRequest"){const c=t.get(o);return{model:s,type:a,sortOrder:c-.1}}return{model:s,type:a,sortOrder:r}});return M(m("sortOrder"),"desc",n).map(m("model"))}const Oe=e=>_e.invalidateQueries({queryKey:e});function qe(){return Oe([F])}const Pe=async(e,t)=>{const n=await t(),s=e.getBasicResourceByAction("archive");await ye(s,e,n,"archive"),await qe()},O=ne(["informationSourceNot","informationSource"]);function q(e,t={},n=!1){let s=n?ke(e.resources,e.bundle):e.resources;return t.informationSource&&(s=s.filter(a=>{var r;return((r=a.informationSource)==null?void 0:r.type)===t.informationSource})),t.informationSourceNot&&(s=s.filter(a=>{var r;return((r=a.informationSource)==null?void 0:r.type)!==t.informationSourceNot})),s}async function ut(e,t,n=[]){const[s={}]=n;try{const a=await z("MedicationStatement",e,{patientUPID:t.UPID,_include:"MedicationStatement:medication",...O(s)}),r=q(a,s,!1);return{bundle:a.bundle,medications:r}}catch(a){throw T("Failed fetching medications for patient",a)}}async function mt(e,t,n=[]){const[s={}]=n;try{const a=X.timeMetric("req.active_medications"),r=await G("MedicationStatement",e,"ActiveMedications",{patientUPID:t.UPID,_include:"MedicationStatement:medication",...O(s)}),o=q(r,s,!0);return a(),{bundle:r.bundle,medications:o}}catch(a){throw T("Failed fetching medications for patient",a)}}function ke(e,t){const n=ae(t);return e.filter(s=>ge(s,n)!==void 0)}function pt(e,t){const n=e.filter(a=>!t.some(r=>r.rxNorm===a.rxNorm));return{builderMedications:t.map(a=>{var u,p;const r=S(f=>f.rxNorm===a.rxNorm,e);if(!r)return a;const o=I(a.resource),c=[W,K,Z,J,ee,te];o.extension=(u=r.resource.extension)==null?void 0:u.filter(f=>c.includes(f.url));const l=I(S({url:U},r.resource.extension));return l&&(l.url=$,(p=o.extension)==null||p.push(l)),new D(o,a.includedResources,a.revIncludes)}),otherProviderMedications:n}}function P(e){const t=e?new D(e).aggregatedFrom:[],n=g(m("reference"),ie("/"),C),s=g(L(m("type")),w(b(n)))(t);return De(B,[(e==null?void 0:e.id)||"empty"],V(async(a,r)=>{try{if(!e)return{includedResources:{},medications:[]};const[o,c,l,u]=await Promise.all([y("MedicationStatement",a,r.UPID,s.MedicationStatement),y("MedicationAdministration",a,r.UPID,s.MedicationAdministration),y("MedicationRequest",a,r.UPID,s.MedicationRequest,["MedicationRequest:requester"]),y("MedicationDispense",a,r.UPID,s.MedicationDispense,["MedicationDispense:performer","MedicationDispense:prescription"])]),p=Q(R([o.bundle,c.bundle,l.bundle,u.bundle])),f=R([...o.resources,...c.resources,...l.resources,...u.resources]).map(E=>new A(E,p));return{medications:we(Ne(f,(E,N)=>E.date===N.date&&E.resource.resourceType===N.resource.resourceType),"date","desc",!0),includedResources:p}}catch(o){throw new Error(`Failed fetching medication history for medication ${e==null?void 0:e.id}: ${o}`)}},"req.medication_history"))}function ft(e){const[t,n]=d.useState(),s=P(e);return d.useEffect(()=>{const{includedResources:a={},medications:r=[]}=s.data||{};if(t===void 0&&r.length){const o=g(b(m("resource")),oe(ce("resourceType","MedicationRequest")),le(c=>Date.parse(c.authoredOn)),b(c=>new A(c,a)),C,m("prescriber"))(r);n(o||"")}},[t,s.data]),{isLoading:s.isFetching,lastPrescriber:t}}function y(e,t,n,s=[],a=[]){return s.length>0?Y(e,t,{_id:s.join(","),_include:[`${e}:patient`,`${e}:medication`,...a],"_include:iterate":"Patient:organization","patient.identifier":`${j}|${n}`}):{resources:[],bundle:void 0}}function Et(){const{getRequestContext:e}=H();return d.useCallback(async t=>{await Pe(t,e)},[e])}const Fe=10,v=fe(({medication:e})=>{const[t,n]=d.useState([]),s=P(e.resource),a=s.isLoading;return d.useEffect(()=>{if(s.data){const{medications:r}=s.data;n(Ae(r).map(Be))}},[s.data]),a?i.createElement(i.Fragment,null,i.createElement("h2",{className:"ctw-text-lg ctw-font-semibold"},"Medication History"),i.createElement(Ee,{message:""})):i.createElement(i.Fragment,null,i.createElement("h2",{className:"ctw-text-lg ctw-font-semibold"},"Medication History"),t.length?i.createElement(_,{entries:t,limit:Fe}):i.createElement("span",null,"No history available for this medication."))},"MedicationHistory");function Ve(e){var s,a;const t=e.resource,n=new D(t,e.includedResources);return{date:e.dateLocal,id:e.id,title:"Medication Reviewed",hideEmpty:!1,subtitle:(a=(s=n.patient)==null?void 0:s.organization)==null?void 0:a.name,data:[{label:"Status",value:de(n.displayStatus)},{label:"Instructions",value:n.dosage}]}}function Be(e){if(e.resourceType==="MedicationStatement")return Ve(e);if(e.resourceType==="MedicationRequest")return He(e);if(e.resourceType==="MedicationDispense")return Ue(e);if(e.resourceType==="MedicationAdministration")return $e(e);throw new Error(`Unknown medication resource type "${e.resourceType}"`)}function He(e){const t=e.resource,{prescriber:n}=e,{name:s,address:a,telecom:r}=new Me(t,e.includedResources).pharmacy,{numberOfRepeatsAllowed:o="",initialFill:c}=t.dispenseRequest||{},{value:l="",unit:u=""}=(c==null?void 0:c.quantity)||{};return{date:e.dateLocal,id:e.id,title:"Prescription Ordered",subtitle:n,hideEmpty:!1,data:[{label:"Quantity",value:[l,u].join(" ")},{label:"Refills Allowed",value:o},{label:"Instructions",value:e.dosage},{label:"Prescriber",value:n},{label:"Pharmacy",value:i.createElement(i.Fragment,null,s&&i.createElement("div",null,s),a&&i.createElement("div",null,a),r&&i.createElement("div",null,"T: ",r))}]}}function Ue(e){const t=e.resource,n=new be(t,e.includedResources),{quantityDisplay:s,supplied:a,performerDetails:r}=n,{name:o,address:c,telecom:l}=r;return{date:e.dateLocal,hideEmpty:!1,id:e.id,title:"Medication Filled",subtitle:x([s,a?`${a} supplied`:null]).join(", "),data:[{label:"Quantity",value:s},{label:"Days supply",value:a},{label:"Pharmacy",value:i.createElement(i.Fragment,null,o&&i.createElement("div",null,o),c&&i.createElement("div",null,c),l&&i.createElement("div",null,"T: ",l))}]}}function $e(e){const t=e.resource,n=new he(t,e.includedResources);return{id:e.id,date:e.dateLocal,hideEmpty:!1,title:"Medication Administered",subtitle:x([n.dosageDisplay,n.dosageRoute]).join(", "),data:[{label:"Dosage",value:n.dosageDisplay},{label:"Route",value:n.dosageRoute},{label:"Start Date",value:n.effectivePeriod.start},{label:"End Date",value:n.effectivePeriod.end}]}}try{v.displayName="MedicationHistory",v.__docgenInfo={description:"Displays the history of a medication",displayName:"MedicationHistory",props:{medication:{defaultValue:null,description:"",name:"medication",required:!0,type:{name:"MedicationStatementModel"}}}}}catch{}export{_ as C,v as M,ft as a,mt as b,ut as g,pt as s,Et as u};
